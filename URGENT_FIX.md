# 🚨 緊急修正ガイド

## 問題1: 画像分析エラー（最優先）

### エラーメッセージ
```
"image_url in input form must be less than 5 characters"
```

### 原因
Difyワークフローの`image_url`入力に文字数制限が設定されている

### 修正方法

#### ステップ1: Difyワークフローを開く

```
https://dify.ai/
→ ワークフローを開く
```

#### ステップ2: Startブロックを修正

1. **Startブロックをクリック**

2. **`image_url` 変数を探す**

3. **設定を以下のように変更:**

```
┌─────────────────────────────────────┐
│ 変数設定: image_url                 │
├─────────────────────────────────────┤
│ 変数名: image_url                   │
│ タイプ: Paragraph（または String）  │
│ 必須: ❌ いいえ                     │
│ 最小文字数: (空欄)                  │
│ 最大文字数: (空欄または削除)        │
│ デフォルト値: (空欄)                │
└─────────────────────────────────────┘
```

**重要ポイント:**
- ✅ タイプを `Paragraph` に変更（長文対応）
- ✅ 最大文字数を削除または非常に大きくする（10000000など）
- ✅ 必須のチェックを外す

#### ステップ3: 保存して再公開

1. 「保存」ボタンをクリック
2. 「公開」ボタンをクリック
3. 確認

#### ステップ4: サーバーを再起動

```bash
cd /Users/yuchenzhou/Desktop/kisekae
npm run dev
```

---

## 問題2: 画像生成エラー（Stability AIクレジット不足）

### エラーメッセージ
```
"You lack sufficient credits to make this request"
```

### 原因
Stability AIのクレジットが不足

### 解決方法の選択肢

#### 🔷 オプションA: クレジットをチャージ（簡単）

**手順:**

1. Stability AIにログイン
   ```
   https://platform.stability.ai/account/credits
   ```

2. クレジットを購入
   - 最小: $10（約1000クレジット）

3. Difyワークフローは変更不要

**メリット:** ワークフローを変更する必要なし

**デメリット:** コストがかかる

---

#### 🔷 オプションB: DALL-E 3に切り替え（推奨）

**手順:**

##### 1. OpenAI APIキーを取得

```
https://platform.openai.com/
→ API keys
→ Create new secret key
```

##### 2. Difyにキーを設定

```
Dify → 設定 → モデルプロバイダー → OpenAI
→ APIキーを入力 → 保存
```

##### 3. Difyワークフローを修正

1. **ワークフローを開く**

2. **IFブランチ（画像生成ルート）のStability AIブロックを削除**

3. **新しいツールブロックを追加:**
   - 左サイドバーから「ツール」をドラッグ
   - ツール選択: **DALL-E 3**

4. **DALL-E 3の設定:**

```
プロンプト: {{#llm_translation.text#}}
サイズ: 1024x1024
品質: standard
スタイル: vivid
```

5. **接続を修正:**

```
[LLM翻訳] → [DALL-E 3] → [End]
```

6. **Endブロックを修正:**

```
出力変数: image_url
ソース: {{#dalle3.output#}} または {{#dalle3.image_url#}}
```

7. **保存して再公開**

**メリット:**
- ✅ 画像品質が高い
- ✅ 日本語プロンプトにも対応
- ✅ OpenAIクレジットは最初$5無料

**デメリット:**
- ワークフローの修正が必要（5分程度）

---

## 🎯 推奨する順序

### ステップ1: まず画像分析を修正（最優先）

1. Difyワークフローで`image_url`の文字数制限を削除
2. タイプを`Paragraph`に変更
3. 保存・再公開
4. サーバー再起動
5. **画像分析をテスト**

### ステップ2: 画像生成を修正

**どちらか選択:**

- **簡単:** Stability AIのクレジットをチャージ
- **推奨:** DALL-E 3に切り替え

---

## 📋 チェックリスト

### 画像分析を動かすために

- [ ] Difyワークフローを開いた
- [ ] Startブロックの`image_url`を確認
- [ ] タイプを`Paragraph`に変更
- [ ] 最大文字数制限を削除
- [ ] 保存・再公開
- [ ] サーバー再起動
- [ ] ブラウザでテスト

### 画像生成を動かすために

**オプションA: Stability AI**
- [ ] クレジットをチャージ

**オプションB: DALL-E 3**
- [ ] OpenAI APIキーを取得
- [ ] Difyに設定
- [ ] ワークフローでDALL-E 3に変更
- [ ] 保存・再公開
- [ ] サーバー再起動
- [ ] ブラウザでテスト

---

## 🆘 それでも解決しない場合

### 画像分析が動かない

**代替案: 2つの独立したワークフローに戻す**

1. 新しい「画像分析専用」ワークフローを作成
2. Startブロックに`image_url`のみ（Paragraphタイプ）
3. LLM Visionで分析
4. 環境変数を4つに戻す

コードは既に対応しているので、環境変数を追加するだけで動きます。

---

**まずは画像分析を動かすことを優先しましょう！**

Difyワークフローの`image_url`の文字数制限を削除してください！


