# 📸 Dify 画像分析ワークフロー設定ガイド

撮影した写真を AI が分析して、説明文を生成する機能を設定します。

---

## 🎯 目標

撮影した写真を Dify に送信し、AI が画像を分析して日本語で説明を生成する。

---

## 📋 必要な準備

### 1. Dify プロジェクトにログイン

```
https://dify.ai/
```

### 2. 使用する LLM プロバイダーを確認

画像分析には**Vision 機能**を持つ LLM が必要です：

#### 推奨プロバイダー

| プロバイダー  | モデル                     | Vision 対応 | 日本語対応 | コスト |
| ------------- | -------------------------- | ----------- | ---------- | ------ |
| **OpenAI**    | GPT-4o (GPT-4 with vision) | ✅          | ✅         | 高     |
| **OpenAI**    | GPT-4o-mini                | ✅          | ✅         | 中     |
| **Anthropic** | Claude 3.5 Sonnet          | ✅          | ✅         | 高     |
| **Anthropic** | Claude 3 Haiku             | ✅          | ✅         | 低     |
| **Google**    | Gemini 1.5 Pro             | ✅          | ✅         | 中     |

**推奨: GPT-4o-mini**（コストと性能のバランスが良い）

---

## 🔧 Dify ワークフロー作成手順

### ステップ 1: 新しいワークフローを作成

1. Dify ダッシュボードで「**ワークフローを作成**」をクリック
2. 名前: `画像分析` または `Image Analysis`
3. タイプ: **ワークフロー** を選択

---

### ステップ 2: ブロック構成

以下の 3 つのブロックを配置します：

```
[Start] → [LLM] → [End]
```

---

### ステップ 3: Start ブロック設定

#### 1. Start ブロックをクリック

#### 2. 入力変数を追加

| 設定項目   | 値                                                 |
| ---------- | -------------------------------------------------- |
| **変数名** | `image_url`                                        |
| **タイプ** | `File` または `String`                             |
| **必須**   | ✅ はい                                            |
| **説明**   | 分析する画像の URL（Base64 データまたは HTTP URL） |

![Start設定例](https://i.imgur.com/example1.png)

---

### ステップ 4: LLM ブロック設定

#### 1. LLM ブロックを追加

左サイドバーから「**LLM**」ブロックをドラッグ

#### 2. モデルを選択

**推奨設定:**

| 設定項目         | 値            |
| ---------------- | ------------- |
| **プロバイダー** | OpenAI        |
| **モデル**       | `gpt-4o-mini` |
| **Temperature**  | 0.7           |
| **Max Tokens**   | 500           |
| **Vision 機能**  | ✅ 有効       |

#### 3. プロンプトを設定

**System Prompt（システムプロンプト）:**

```
あなたは画像を詳しく分析する専門家です。
与えられた画像を分析し、以下の観点から詳細に説明してください：

1. 全体的な印象
2. 服装・ファッション
3. 色使い
4. スタイル・雰囲気
5. その他の特徴

説明は日本語で、200〜300文字程度で自然な文章として出力してください。
```

**User Prompt（ユーザープロンプト）:**

```
この画像を分析して、詳しく説明してください。

画像: {{#start.image_url#}}
```

#### 4. 画像入力の設定

- **Vision 機能を有効化**
- **画像入力フィールド**: `{{#start.image_url#}}`を選択
- フォーマット: Base64 または URL（両方サポート）

![LLM設定例](https://i.imgur.com/example2.png)

---

### ステップ 5: End ブロック設定

#### 1. End ブロックをクリック

#### 2. 出力変数を設定

| 設定項目   | 値                                         |
| ---------- | ------------------------------------------ |
| **変数名** | `description`                              |
| **タイプ** | `String`                                   |
| **ソース** | `{{#llm.text#}}` または `{{#llm.output#}}` |

**変数の選び方:**

- LLM ブロックの出力をクリック
- 「変数を選択」から `text` または `output` を選択
- 自動的に `{{#llm.text#}}` の形式になる

![End設定例](https://i.imgur.com/example3.png)

---

### ステップ 6: ブロックを接続

```
Start → LLM → End
```

1. **Start**の右側の接続ポイントをドラッグ
2. **LLM**の左側の接続ポイントにドロップ
3. **LLM**の右側の接続ポイントをドラッグ
4. **End**の左側の接続ポイントにドロップ

---

### ステップ 7: ワークフローをテスト

#### 1. 「実行」ボタンをクリック

#### 2. テスト画像を入力

**方法 1: Base64 データ**

```
data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUA...
```

**方法 2: HTTP URL**

```
https://example.com/test-image.jpg
```

#### 3. 結果を確認

出力例:

```
この画像には、明るい色のワンピースを着た人物が写っています。
服装は優雅でエレガントな印象を与え、赤やピンクのような
暖色系の色使いが特徴的です。全体的に華やかで女性らしい
雰囲気が演出されています。
```

---

### ステップ 8: API 設定を公開

#### 1. ワークフローを保存

「**保存**」ボタンをクリック

#### 2. API として公開

1. 右上の「**公開**」ボタンをクリック
2. 「**API として公開**」を選択
3. 確認して公開

#### 3. API 情報を取得

公開後、以下の情報が表示されます：

```
API Key (APIシークレットキー): app-xxxxxxxxxxxxxxxxxxxxxx
API Endpoint (APIサーバー): https://api.dify.ai/v1/workflows/run
```

---

## 🔐 環境変数の設定

### `.env.local` ファイルに追加

プロジェクトルートの `.env.local` ファイルに以下を追加：

```bash
# Dify 画像分析API設定
DIFY_ANALYZE_API_KEY=app-xxxxxxxxxxxxxxxxxxxxxx
DIFY_ANALYZE_API_ENDPOINT=https://api.dify.ai/v1/workflows/run
```

**注意点:**

- `DIFY_ANALYZE_API_KEY`: 「API シークレットキー」をコピー
- `DIFY_ANALYZE_API_ENDPOINT`: 「API サーバー」の URL をコピー
- 既存の `DIFY_API_KEY` と `DIFY_API_ENDPOINT`（画像生成用）とは別に設定

---

## 🎨 OpenAI API キーの設定（必要な場合）

### OpenAI API キーを取得

#### 1. OpenAI Platform にログイン

```
https://platform.openai.com/
```

#### 2. API キーを作成

1. 左サイドバーで「**API keys**」をクリック
2. 「**+ Create new secret key**」をクリック
3. 名前: `Dify Image Analysis`
4. API キーをコピー（後で確認できないので注意）

#### 3. Dify にキーを設定

1. Dify ダッシュボードに戻る
2. 左サイドバーで「**設定**」→「**モデルプロバイダー**」
3. 「**OpenAI**」を選択
4. API キーを入力
5. 「**保存**」

---

## 🚀 アプリケーションの起動

### 1. サーバーを起動

```bash
cd /Users/yuchenzhou/Desktop/kisekae
npm run dev
```

### 2. ブラウザでテスト

```
http://localhost:3000
```

---

## 🎯 使用フロー

### 完全な流れ

```
1. スタート画面
   ↓ 「撮影をスタート」

2. フォーム入力
   - ニックネーム入力
   - 服装プロンプト入力
   ↓ 「撮影開始」

3. カメラ画面
   ✓ カメラ起動
   ✓ AI画像生成（自動）
   ↓ 「撮影する」

4. 写真撮影
   ✓ 写真保存（自動）
   ✓ 画像分析開始（自動）
   ↓ 10-20秒待つ

5. AI画像分析結果表示
   - AIが生成した説明文が表示される
   - 「再分析」ボタンで再度分析可能
```

---

## 🐛 トラブルシューティング

### エラー: 「Dify 画像分析 API 設定が不完全です」

**原因:** `.env.local` の設定が不足

**解決方法:**

```bash
# .env.localを確認
cat .env.local

# 必要な変数があるか確認
# DIFY_ANALYZE_API_KEY=app-xxxx
# DIFY_ANALYZE_API_ENDPOINT=https://api.dify.ai/v1/workflows/run

# サーバーを再起動
npm run dev
```

---

### エラー: 「モデルが Vision をサポートしていません」

**原因:** 選択したモデルが Vision 機能を持っていない

**解決方法:**

1. Dify ワークフローを開く
2. LLM ブロックを選択
3. モデルを変更: `gpt-4o-mini` または `gpt-4o`
4. 保存して再公開

---

### エラー: 「説明文が取得できませんでした」

**原因 1:** End ブロックの出力変数が正しく設定されていない

**解決方法:**

1. End ブロックを開く
2. 出力変数のソースを確認: `{{#llm.text#}}`
3. LLM の出力変数名を確認して調整

**原因 2:** LLM ブロックのプロンプトが適切でない

**解決方法:**

1. LLM ブロックの System Prompt を確認
2. 出力形式を明確に指定

---

### エラー: 「OpenAI API クォータ超過」

**原因:** OpenAI アカウントのクレジットが不足

**解決方法:**

**オプション 1: OpenAI をチャージ**

```
https://platform.openai.com/account/billing
```

**オプション 2: 別のプロバイダーに切り替え**

- **Claude 3 Haiku** (低コスト、高性能)
- **Gemini 1.5 Pro** (無料枠あり)

Dify ワークフローでモデルプロバイダーを変更

---

### 画像が分析されない

**チェックリスト:**

1. ✅ `.env.local` に `DIFY_ANALYZE_API_KEY` と `DIFY_ANALYZE_API_ENDPOINT` が設定されているか
2. ✅ サーバーを再起動したか (`npm run dev`)
3. ✅ Dify ワークフローが正しく公開されているか
4. ✅ LLM ブロックで Vision 機能が有効になっているか
5. ✅ ブラウザのコンソールでエラーが出ていないか（F12 で確認）

---

## 📊 コスト比較

### GPT-4o-mini の場合

| 操作          | 画像サイズ | トークン数     | コスト（概算） |
| ------------- | ---------- | -------------- | -------------- |
| 画像分析 1 回 | 720p       | ~500 tokens    | $0.0015        |
| 100 回分析    | 720p       | ~50,000 tokens | $0.15          |

### Claude 3 Haiku の場合

| 操作          | 画像サイズ | トークン数     | コスト（概算） |
| ------------- | ---------- | -------------- | -------------- |
| 画像分析 1 回 | 720p       | ~500 tokens    | $0.0005        |
| 100 回分析    | 720p       | ~50,000 tokens | $0.05          |

**推奨:** 開発中は**Claude 3 Haiku**（低コスト）、本番では**GPT-4o-mini**（バランス良）

---

## 🎉 完成！

### 確認ポイント

1. ✅ 写真を撮影すると、自動的に画像分析が開始される
2. ✅ 10〜20 秒後、AI 生成の説明文が表示される
3. ✅ 「再分析」ボタンで別の説明を生成できる
4. ✅ 説明文は日本語で自然な文章になっている

---

## 📝 次のステップ

### さらなる改善案

1. **説明の詳細度を調整**

   - LLM ブロックのプロンプトを変更
   - より詳しい分析や特定の観点を追加

2. **複数の分析結果を保存**

   - データベースに説明文を保存
   - 履歴として閲覧可能に

3. **スタイル評価を追加**

   - 服装が指定したプロンプトに合っているか評価
   - スコアリング機能

4. **多言語対応**
   - 英語、中国語など他の言語での説明も生成

---

## 🆘 サポート

問題が解決しない場合は、以下の情報を共有してください：

1. `.env.local` の内容（API キーは隠して）
2. ブラウザのコンソールエラー（F12 で確認）
3. サーバーのターミナルログ
4. Dify ワークフローのスクリーンショット

---

**これで画像分析機能の設定は完了です！🎊**

撮影した写真を AI が自動的に分析し、素敵な説明文を生成してくれます！✨
